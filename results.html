
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Poll Results</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
            <style> body { font-family: 'Inter', sans-serif; } </style>
        </head>
        <body class="bg-gray-50">
            <div class="container mx-auto p-4 md:p-8">
                <div id="loading" class="text-center mt-20"><h1 class="text-2xl font-semibold">Loading Results...</h1></div>
                <div id="results-container" class="hidden">
                    <h1 id="poll-title" class="text-4xl font-bold text-center text-gray-800 mb-10"></h1>
                    <div id="charts-container" class="space-y-12"></div>
                </div>
            </div>
            <script>
                const { createClient } = supabase;
                const SUPABASE_URL = 'https://ttzakubulphvibneblpm.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0emFrdWJ1bHBodmlibmVibHBtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExMDYwMTYsImV4cCI6MjA2NjY4MjAxNn0.SXB9SUHUEOrpOsnZSsfsnCxqkc4wUbucpCSGlKghQjM';
                const db = createClient(SUPABASE_URL, SUPABASE_KEY, { realtime: { params: { eventsPerSecond: 10 } } });
                const loadingDiv = document.getElementById('loading'), resultsContainer = document.getElementById('results-container'), pollTitleEl = document.getElementById('poll-title'), chartsContainer = document.getElementById('charts-container');
                let pollData, charts = [];
                async function initialLoad() {
                    const urlParams = new URLSearchParams(window.location.search); const pollId = urlParams.get('id');
                    if (!pollId) { loadingDiv.innerHTML = '<h1 class="text-2xl font-semibold text-red-500">Error: Poll ID not found in URL.</h1>'; return; }
                    try {
                        const { data: poll, error: pollError } = await db.from('polls').select('*').eq('id', pollId).single();
                        if (pollError) throw pollError; if (!poll) throw new Error("Poll not found."); pollData = poll;
                        pollTitleEl.textContent = pollData.title; createChartStructures();
                        await updateResults();
                        loadingDiv.classList.add('hidden'); resultsContainer.classList.remove('hidden');
                        subscribeToChanges();
                    } catch(error) { console.error("Error loading results:", error); loadingDiv.innerHTML = `<h1 class="text-2xl font-semibold text-red-500">Error loading results: ${error.message}</h1>`; }
                }
                function createChartStructures() {
                    chartsContainer.innerHTML = ''; charts = [];
                    pollData.questions.forEach((question, index) => {
                        const chartId = `chart-${index}`; const chartWrapper = document.createElement('div'); chartWrapper.className = 'p-6 bg-white rounded-2xl shadow-lg';
                        chartWrapper.innerHTML = `<h2 class="text-2xl font-semibold text-gray-700 mb-4">${index + 1}. ${question.title}</h2><canvas id="${chartId}"></canvas>`;
                        chartsContainer.appendChild(chartWrapper);
                        const ctx = document.getElementById(chartId).getContext('2d');
                        const chart = new Chart(ctx, {
                            type: 'bar', data: { labels: question.answers, datasets: [{ label: 'Votes', data: new Array(question.answers.length).fill(0), backgroundColor: 'rgba(79, 70, 229, 0.8)', borderColor: 'rgba(79, 70, 229, 1)', borderWidth: 1 }] },
                            options: { indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { display: false } } }
                        });
                        charts.push(chart);
                    });
                }
                async function updateResults() {
                    if (!pollData) return;
                    const { data: answers, error } = await db.from('poll_answers').select('question_index, answer_index').eq('poll_id', pollData.id);
                    if (error) { console.error("Error fetching answers:", error); return; }
                    charts.forEach(chart => chart.data.datasets[0].data.fill(0));
                    answers.forEach(answer => { const { question_index, answer_index } = answer; if (charts[question_index]) { charts[question_index].data.datasets[0].data[answer_index]++; } });
                    charts.forEach(chart => {
                        const totalVotes = chart.data.datasets[0].data.reduce((sum, value) => sum + value, 0);
                        chart.options.scales.x.ticks.callback = function(value) {
                            if (totalVotes === 0 || !Number.isInteger(value)) return value;
                            const percentage = (value / totalVotes * 100).toFixed(0) + '%';
                            return `${value} (${percentage})`;
                        };
                        chart.update();
                    });
                }
                function subscribeToChanges() {
                    const channel = db.channel(`poll_answers:${pollData.id}`).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'poll_answers', filter: `poll_id=eq.${pollData.id}` }, (payload) => { updateResults(); }).subscribe();
                }
                window.onload = initialLoad;
            </script>
        </body>
        </html>
